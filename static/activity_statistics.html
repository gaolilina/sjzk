<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>活动统计</title>
<meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1.0, maximum-scale=1.0, minimum-scale=0.3">
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/global.css" />
<link rel="stylesheet" href="css/DateTimePicker.min.css" />
<link rel="stylesheet" href="lib/Hui-iconfont/1.0.8/iconfont.css">
<link rel="stylesheet" href="css/jquery-confirm-3.0.3.min.css">
<script src="js/jquery-3.1.1.min.js"></script>
<script src="js/base.js"></script>
<script src="js/jquery-confirm-3.0.3.min.js"></script>
<script src="js/echarts.min.js"></script>
<script src="js/JsonExportToCSV.js"></script>
<style>
    .header{
        height: 60px;
        background-color: #00BBD9;
        padding-left: 30px;
        line-height: 60px;
        font-size: 1.1em;
        color: #fff;
    }
    .buttons{
        float: right;
    }
    .title-bar{padding:8px 20px;margin-bottom:20px;font-size:14px;background-color:#E1FAFE;}
    input[type="button"]{
        background-color:#55CE63;float:right;margin-right:20px;margin-top:-5px;;width:65px;height:30px;border:1px solid #55CE63;border-radius:3px;
    }
    #div-echarts{
        text-align: center;
    }
    table{
        width: 1230px;
        font-family: verdana,arial,sans-serif;
        font-size: 1.05em;
        border-collapse: collapse;
    }
    tr:hover {
        background-color: #F4F5F7;
        transition:background-color 0.1s linear;
    }
    table th {
        border-width: 1px;
        padding: 8px;
        border-style: solid;
        font-weight: 500;
        border-color: #C1C1C1;
        background-color: #F5FAFE;
        text-align: center;
    }
    table td {
        border-width: 1px;
        padding: 8px;
        border-style: solid;
        border-color: #C1C1C1;
        text-align: center;
        word-wrap: break-word;
        word-break:break-all;
    }
    .line-space{
        height: 100px;
    }
    .c-blue{color:blue;}
    .font-bold{font-weight:bold;}
    .result{display:inline-block;margin:0 5px;}
    @media (max-width: 768px) {
        td{
            display: block;
            width: 100%;
        }
        .jconfirm .jconfirm-scrollpane{
            margin-left: 10%;
        }
    }
</style>
</head>
<body>
<div class="header">活动统计数据</div>
<div class="title-bar">统计图表</div>
<div id="div-echarts"></div>
<div class="title-bar">统计表格<input type="button" id="export" value="导出"/></div>
<table style="width:1200px;margin:0 auto;">
    <thead><tr>
            <th class="min-width-150">类别</th>
            <th class="min-width-150">选项</th>
            <th class="min-width-200">统计(<i id="person_count"></i>人)</th>
    </tr></thead>
    <tbody id="statistics_body">
    </tbody>
</table>
</body>
<div id="export_data" style="display: none;"></div>
<div class="line-space"></div>
<script type="text/javascript">
$(document).ready(function(){
    let id = getRequest()['id'];
    let token = getRequest()['token'];
    $.ajax({
        type: 'GET',
        url: base_url+'web/activity/'+id+'/analysis/',
        data: {},
        dataType: 'json',
        headers: {'X-USER-TOKEN': token},
        error: function (err) {
            console.log(err);
            showAlert('无法获取分析结果');
        },
        success: function (res) {
            if (res.code == 0) {
                show_statistics_result(res.data);
            } else {
                showAlert(res.msg || '获取失败');
            }
        }
    });
    $('#export').click(function(){
        let title = '活动统计表格'+id;
        let export_data = JSON.parse($('#export_data').html());
        JSONToCSVConvertor({data:export_data, title: title, showLabel: true});
    }); 
});
function show_statistics_result(result){
    let statistic_list = [];
    // 统计图表
    let statistic_analysis = [];
    // 统计表格
    let statistic_table_html = [];
    // 总数
    let sum = result.sum;
    $('#person_count').html(sum);//总人数
    // 专业统计
    statistic_list.push({name: '专业统计', data: result.profession});
    // 单位统计
    statistic_list.push({name: '单位统计', data: result.unit});
    // 角色统计
    let role = result.role;
    statistic_list.push({name: '角色统计', data: result.role});
    // 性别统计
    let gender = result.gender;
    statistic_list.push({name: '性别统计', data: result.gender});
    // 地域统计
    let province = result.province;
    statistic_list.push({name: '地域统计', data: result.province});

    var echarts_html = '';
    for(let index in statistic_list){
        // 统计图表
        let e_id = 'div-echarts'+index;
        echarts_html += '<div id="'+e_id+'" style="width:560px;height:350px;margin-right:20px;margin-bottom:20px;" class="inline-block"></div>';
        let name = statistic_list[index].name;
        let data = statistic_list[index].data;
        let s_analysis = {e_id: e_id,e_name: name};
        let l_data = [];
        let s_data = [];
        for(let category in data){
            // 统计图表
            let count = data[category];
            l_data.push(category);
            s_data.push({'name':category,'value':count});
        }
        s_analysis.l_data = l_data;
        s_analysis.s_data = s_data;
        statistic_analysis.push(s_analysis);
    }
    $('#div-echarts').html(echarts_html);
    let export_data = []; // 导出表格数据
    // 填充图表
    for(let index in statistic_analysis){
        let s_analysis = statistic_analysis[index];
        pie_echarts(s_analysis.e_id,s_analysis.e_name,s_analysis.l_data,'',s_analysis.s_data);
        // 统计表格
        let data = s_analysis.s_data;
        // 统计表格
        statistic_table_html += '<tr><td rowspan="'+data.length+'">'+s_analysis.e_name+'</td>';
        for(let index in data){
            let count = data[index].value;
            let percent = count/sum*100;
            if(index!=0){
                statistic_table_html += '<tr>';
                export_data.push({'类别': '','选项': data[index].name,'统计': count+'|'+percent+'%'});// 导出表格数据
            } else{
                export_data.push({'类别': s_analysis.e_name,'选项': data[index].name,'统计': count+'|'+percent+'%'});// 导出表格数据
            }
            statistic_table_html += '<td>'+data[index].name+'</td><td>'+count+',<div class="inline-block c-blue font-bold result">'+percent+'%</div></td></tr>';
        }
    }
    $('#export_data').html(JSON.stringify(export_data));
    $('#statistics_body').html(statistic_table_html);
}
//pie_echarts('div-echarts3','饼图',['name1','name2','name3'],'',[{name:'name1',value:1},{name:'name2',value:2},{name:'name3',value:3}]);
function pie_echarts(div_echarts,e_name,l_data,s_name,s_data){
    option = {
        title : {
            text: e_name,
            subtext: '各选项人数统计',
            left:'center',
            bottom:0
        },
        tooltip : {
            trigger: 'item',
            // formatter: "{a} <br/>{b} : {c} ({d}%)"
            formatter: "{b} : {c} ({d}%)"
        },
        legend: {
            type: 'scroll',
            orient: 'vertical',
            right: 10,
            top: 20,
            bottom: 20,
            data: l_data,
            // selected: {}
        },
        series : [
            {
                name: s_name,
                type: 'pie',
                radius : '55%',
                center: ['50%', '50%'],
                data: s_data,
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };
    var myChart = echarts.init(document.getElementById(div_echarts));
    myChart.setOption(option);
}
</script>
</html>

