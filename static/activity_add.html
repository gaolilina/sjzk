<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>活动创建</title>
<meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1.0, maximum-scale=1.0, minimum-scale=0.3">
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/global.css" />
<link rel="stylesheet" href="css/DateTimePicker.min.css" />
<link rel="stylesheet" href="lib/Hui-iconfont/1.0.8/iconfont.css">
<link rel="stylesheet" href="css/jquery-confirm-3.0.3.min.css">
<script src="js/jquery-3.1.1.min.js"></script>
<script src="js/base.js"></script>
<script src="js/DateTimePicker.min.js"></script>
<script src="js/DatetimePicker-i18n-zh-CN.js"></script>
<script src="js/jquery-confirm-3.0.3.min.js"></script>
<script src="js/activity.js"></script>
<script src="js/field.js"></script>
<script src="js/province_city.js"></script>
<style type="text/css">
    input[type="text"],input[type="textarea"],select{
        width: 300px;
    }
    input[type="button"]{
        margin-top: 0;
        width: 50px;
        height: 30px;
        background: #55CE63;
        color: white;
        border: 0 none;
        font-size: 1em;
        border-radius: 3px;
    }
    .buttons{
        float: right;
    }
    @media (max-width: 980px) {
        td{
            display: block;
            width: 100%;
        }
        input[type="text"],input[type="textarea"],input[type="number"],select{
            width: 100%;
        }
        input[type="button"]{
            float:right;
        }
        #select_field{
            margin-bottom: 10px;
        }
        .btn-field{
            margin-right: 8px;
        }
        #add_stage{
            width: 100%;
        }
        .jconfirm .jconfirm-scrollpane{
            margin-left: 10%;
        }
    }
</style>
</head>
<body>
<form role="form" action="" method="post">
<table>
    <tr>
        <td>标题：</td>
        <td><input name="name" type="text" value="" maxlength="50" required/></td>
    </tr>
    <tr>
        <td>标签：</td>
        <td><input name="tags" type="text" value="" maxlength="50" required/></td>

        <td>类型：</td>
        <td>
            <select name="type" required>
                <option value="" selected="selected">--请选择--</option>
                <option value="0">会议</option>
                <option value="1">讲座</option>
                <option value="2">培训</option>
            </select>
        </td>
    </tr>
    <tr>
        <td>详细内容：</td>
        <td colspan="3"><textarea name="content" maxlength="1000" required></textarea></td>
    </tr>
    <tr>
        <td>参与者类型：</td>
        <td>
            <select name="user_type" required>
                <option value="0" selected="selected">不限</option>
                <option value="1">学生</option>
                <option value="2">教师</option>
                <option value="3">社会人员</option>
            </select>
        </td>
        <td>领域：</td>
        <td><select name="field" id="select_field"></select></td>
    </tr>
    <tr>
        <td>开始时间：</td>
        <td><input name="time_started" type="text" data-field="datetime" readonly required/></td>
    
        <td>结束时间：</td>
        <td><input name="time_ended" type="text" data-field="datetime" readonly required/></td>
    </tr>
    <tr>
        <td>省：</td>
        <td><select name="province" required></select></td>

        <td>市：</td>
        <td><select name="city" required></select></td>
    </tr>
    <tr>
        <td>人数上限：</td>
        <td><input name="allow_user" type="number" value="0" required/> (0为不限)</td>

        <td>机构：</td>
        <td><input name="unit" type="text" value="" required/></td>
    </tr>
    
    <tr>
        <td>当前活动阶段：</td>
        <td>
            <input name="stages" type="hidden" value="" required/>
            <input name="status" type="hidden" value="" required/>
            <select id="status" required></select>
            <input id="add_stage" type="button" value="新增" style="margin-top: 0px;" />
        </td>
    </tr>
    <tr>
        <td colspan="4">
            <div class="buttons">
                <input type="submit" value="保存" />
                <input type="reset" value="取消" />
            </div>
        </td>
    </tr>
</table>
</form>
<div id="dtBox"></div>

<script type="text/javascript">
var stage_count = 0;
var token = null;
$(document).ready(function() {
    token = getRequest()["token"];
    get_field('select_field');//获取初始化field
    get_province();//初始化省市
    setDateTimePicker();
    $('.dir_warn').click(function(e) {
        if (!confirm($(this).data('warn-text'))) {
            e.preventDefault();
        }
    });
});

function setDateTimePicker() {
    var bIsPopup = false;
    $("#dtBox").DateTimePicker({
        isPopup: bIsPopup,
        language: 'zh-CN'
    });
}

$('form').submit(function(e) {
    alert($('[name=stages]').val());
    if($('[name=time_started]').val()=="") {
        showAlert('请设置开始时间');
        return false;
    }
    if($('[name=time_ended]').val()=="") {
        showAlert('请设置结束时间');
        return false;
    }
    if ($('[name=time_started]').length > 0 && $('[name=time_ended]').length > 0) {
        if (new Date($('[name=time_started]').val()) > new Date($('[name=time_ended]').val())) {
            e.preventDefault();
            showAlert('时间设置有误');
            return false;
        }
    }
    var isSubmit = true;
    $('.stage').each(function(idx, elem) {
        if($(elem).find('input:nth(1)').val()==""){
            showAlert('请设置阶段开始时间');
            isSubmit = false;
            return false;
        }
        if($(elem).find('input:nth(2)').val()==""){
            showAlert('请设置阶段结束时间');
            isSubmit = false;
            return false;
        }
        if(new Date($(elem).find('input:nth(1)').val()) > new Date($(elem).find('input:nth(2)').val())){
            showAlert('时间设置有误');
            isSubmit = false;
            return false;
        }
    });
    if(isSubmit)
        $.ajax({
            type: 'POST',
            url: base_url+"web/activity/",
            data:$('form').serialize(),
            dataType: 'json',
            headers: {'X-USER-TOKEN': token},
            error:function(data) {alert(JSON.stringify(data));showAlert('提交失败');},
            success: function(data){
                showAlertReload('提交成功');
            }
        });
    return false;
});
</script>
</body>

</html>

