<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>问卷调查</title>
</head>
<style type="text/css">
    body{
        margin: 0 10px;
    }
    .title{
        width: 80%;
        margin: 8px auto;
    }
    form{
        margin: 8px auto;
    }
    table{
       margin: 0 auto;
    }
    input[type="text"]{
        padding: 8px 10px;
        width: 90%;
        height: 30px;
        font-size: 1.05em;
        border: 1px solid #C1C1C1;
        border-radius: 3px;
    }
    input[type="radio"],input[type="checkbox"]{
        padding: 8px 10px;
        width: 30px;
        height: 15px;
        font-size: 1.05em;
        border: 1px solid #C1C1C1;
        border-radius: 3px;
    }
    input[type="button"]{
        margin: 10px 20%;
        padding: 8px 10px;
        width: 60%;
        height: 50px;
        font-size: 1.05em;
        vertical-align: middle;
        border: 1px solid #C1C1C1;
        border-radius: 3px;
    }
    td{
        padding: 5px 10px;
        height: 30px;
    }
    div{
        white-space:normal;
        word-break:break-all;
        word-wrap:break-word; 
    }
    .div-ques{
        text-align: left;
        background-color: #F5FAFE;
        font-size: 1.05em;
        padding: 10px 10px;
    }
</style>
<body>
    <br /><br /><hr />
    <h1 align="center"><font color="#FF0000">网站问卷调查</font></h1>
    <h4 class="title" align="left"><div><font id="title">名称:问卷调查</font></div></h4>
    <h4 class="title" align="left"><div><font id="desc">简介:问卷描述</font></div></h4>
    <form>
        <table width="80%" id="paper"></table>
        <input id="paper_id" type="hidden" value=""/>
        <input id="count" type="hidden" value=""/>
        <input type="button" value="提交" id="btn-submit"/>
    </form>
</body>
<script src="js/jquery-3.1.1.min.js"></script>
<script type="text/javascript">
    function getRequest() { 
      var url = location.search; //获取url中"?"符后的字串 
      var theRequest = new Object(); 
      if (url.indexOf("?") != -1) { 
          var str = url.substr(1);
          strs = str.split("&");
          for(let i = 0; i < strs.length; i ++) {
              if(strs[i].indexOf('token')==-1)
                theRequest[strs[i].split("=")[0]]=decodeURI(strs[i].split("=")[1]);
              else
                theRequest[strs[i].split("=")[0]]=decodeURI(strs[i].replace("token=",""));
          } 
      }
      return theRequest; 
    }
    const domain = window.location.host;
    const base_url = "http://"+domain+"/";
    var paper_id = getRequest()["id"];
    $("#paper_id").val(paper_id);
    const token = getRequest()["token"];
    $.ajax({
        type: 'GET',
        url: base_url+"web/paper/"+paper_id+"/",
        headers: {'X-USER-TOKEN': token},
        dataType: 'json',
        error:function(data) {},
        success: function(data){
            init_paper(data);
        }
    });
    // paper = {
    //     "id":1,
    //     "name":"xxxxxxxxxxxxxxxx问卷调查",
    //     "desc":"问卷调查描述xxxxxxxxxxxxxxxxxxxxx",
    //     "count":6,
    //     "questions":[
    //         {"title":"你的名字",
    //         "type":0,
    //         "options":[''],},
    //         {"title":"你的性别",
    //         "type":1,
    //         "options":['男','女'],},
    //         {"title":"你的爱好",
    //         "type":2,
    //         "options":['篮球','足球','羽毛球','乒乓球','棒球'],},
    //         {"title":"你的名字",
    //         "type":0,
    //         "options":[''],},
    //         {"title":"你的性别",
    //         "type":1,
    //         "options":['男','女'],},
    //         {"title":"你的爱好",
    //         "type":2,
    //         "options":['篮球','足球','羽毛球','乒乓球','棒球'],}
    //     ],
    // }
    const category = [
        {'flag':0,'type':'text','desc':'问答题'},
        {'flag':1,'type':'radio','desc':'单选题'},
        {'flag':2,'type':'checkbox','desc':'多选题'},
    ]
    //初始化
    function init_paper(paper){
        $("#count").val(paper.count);
        $("#title").html("问卷名称："+paper.name);
        $("#desc").html("问卷描述："+paper.desc);
        const count = paper.count;
        const questions = paper.questions;
        var content = "";
        for(let i=0;i<count;i++){
            let question = questions[i];
            let options = question.options;
            content += '<tr><td><div class="div-ques">问题'+(i+1)+'：'+question.title+'？</div></td></tr>'
            for(op in options){
                content += '<tr><td><div class="div-answer'+i+'">';
                let type = category[question.type].type; //获取类型
                if(type=="text")
                    content += '<input type="'+type+'" name="'+type+i+'" value="" />';
                else
                    content += '<input type="'+type+'" name="'+type+i+'" value="'+op+'" />'+options[op];
                content += '</div></td></tr>';
            }
        }
        $("#paper").html(content);
    }
    // 提交答案
    $("#btn-submit").click(function(){
        const paper_id = $("#paper_id").val();
        const count = $("#count").val();
        var answers = []
        for(let i=0;i<count;i++){
            let checkbox_answers = [];
            let check_text = "";
            let check_num = -1;
            $(".div-answer"+i+">input").each(function(){
                let type = $(this).attr("type");
                if(type=="text") answers.push(check_text=$(this).val());
                else if(type=="radio" && $(this).is(":checked")) answers.push(check_num=$(this).val()*1);
                else if(type=="checkbox" && $(this).is(":checked")) checkbox_answers.push($(this).val()*1)
            });
            if(checkbox_answers.length!=0) answers.push(checkbox_answers);
            //检测是否有未做题
            if(checkbox_answers.length==0 && check_text=="" && check_num==-1){
                alert('问题'+(i+1)+'为必答题！');
                return;
            }
        }
        // console.log(JSON.stringify(answers));
        r = confirm("确认提交？");
        $.ajax({
            type: 'POST',
            url: base_url+"web/paper/"+paper_id+"/answer/",
            data:{"answers":JSON.stringify(answers)},
            dataType: 'json',
            headers: {'X-USER-TOKEN': token},
            error:function(data) {alert("提交失败!");},
            success: function(data){
                alert("提交成功！");
                window.location.reload();
            }
        });
    });
</script>
</html>
